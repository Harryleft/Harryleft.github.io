<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>生活周刊 - IIIF数字化期刊浏览</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/universalviewer@4.2.1/dist/uv.css"/>
  <style>
    body{margin:0;padding:0;font-family:'Microsoft YaHei',Arial,sans-serif;background:#f5f5f5}
    .header{background:#2c3e50;color:#fff;padding:20px;text-align:center;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .info-panel{background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .catalog-item{background:#fff;border:1px solid #ddd;border-radius:4px;padding:15px;margin:10px 0;cursor:pointer}
    .catalog-item.active{background:#e3f2fd;border-color:#2196f3}
    /* viewer 外壳只放 iframe */
    #uv-frame-wrap{height:800px;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);background:#fff;overflow:hidden}
    #uv-frame{width:100%;height:100%;border:0;display:block}
    
    @media (max-width:768px){ #uv-frame-wrap{height:600px} }
  </style>
</head>
<body>
  <div class="header">
    <h1>生活周刊</h1>
    <p>IIIF数字化期刊浏览系统</p>
  </div>

  <div class="container">
    <div class="info-panel">
      <h2>期刊选择</h2>
      <div id="catalog-list"><div>正在加载期刊目录...</div></div>
    </div>

    <div id="uv-frame-wrap">
      <!-- 把 UV 放到单独的 uv.html 里 -->
      <iframe id="uv-frame" allowfullscreen></iframe>
    </div>
  </div>

  <script>
    function getBaseUrl(){
      const isLocal = ['localhost','127.0.0.1',''].includes(location.hostname);
      return isLocal ? 'http://localhost:8000' : 'https://harryleft.github.io';
    }

    async function loadCatalog(){
      const url = `${getBaseUrl()}/iiif/shenghuozhoukan/collection.json`;
      try{
        const r = await fetch(url);
        if(!r.ok) throw new Error(r.statusText);
        const col = await r.json();
        return (col.items||[]).map((it,i)=>({
          i, manifest: it.id,
          title: (it.label?.['zh-CN']?.[0])||(it.label?.zh?.[0])||(it.label?.en?.[0])||'未知期刊',
          summary: (it.summary?.['zh-CN']?.[0])||(it.summary?.zh?.[0])||(it.summary?.en?.[0])||''
        }));
      }catch(e){ console.error(e); return []; }
    }

    function render(list){
      const root = document.getElementById('catalog-list');
      if(!list.length){ root.innerHTML = '<div>未找到期刊数据</div>'; return; }
      root.innerHTML = list.map(x=>`
        <div class="catalog-item" data-i="${x.i}" data-manifest="${x.manifest}">
          <h3>${x.title}</h3><p>${x.summary}</p>
        </div>`).join('');
      root.addEventListener('click', e=>{
        const item = e.target.closest('.catalog-item'); if(!item) return;
        document.querySelectorAll('.catalog-item').forEach(n=>n.classList.remove('active'));
        item.classList.add('active');
        const manifest = item.dataset.manifest;
        console.log('点击目录项，加载清单:', manifest);
        // 把 manifest 传给 uv.html（用 hash 参数，URLAdaptor 会读取）
        const iframe = document.getElementById('uv-frame');
        // 添加时间戳参数，确保每次都重新加载 iframe
        const ts = Date.now();
        const src = `uv.html?v=${ts}#?iiifManifestId=${encodeURIComponent(manifest)}&embedded=true`;
        console.log('iframe src:', src);
        iframe.src = src; // 强制更新 iframe 的 src，不再检查是否相同
      });
    }

    (async function(){
      const list = await loadCatalog();
      render(list);
      // 可选：默认加载第一个
      // if(list.length){ document.querySelector('.catalog-item').click(); }
    })();
  </script>
</body>
</html>
